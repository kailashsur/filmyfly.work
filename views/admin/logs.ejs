<%- include('../partials/admin_header', { title: title }) %>

<div class="container">
    <div class="admin-dashboard">
        <div class="admin-header">
            <h1><%= title %></h1>
            <div class="admin-user-info">
                <a href="/admin" class="btn btn-secondary">Go to Dashboard</a>
            </div>
        </div>

        <% if (error) { %>
            <div class="alert alert-error">
                <%= error %>
            </div>
        <% } %>

        <div class="logs-section">
            <div class="logs-controls">
                <div class="logs-info">
                    <span id="logSize">Loading...</span>
                    <span id="errorLogSize" style="margin-left: 20px;">Loading...</span>
                </div>
                <div class="logs-actions">
                    <button type="button" class="btn btn-primary" onclick="refreshLogs()">ðŸ”„ Refresh</button>
                    <button type="button" class="btn btn-warning" onclick="clearLogs('app')">Clear App Logs</button>
                    <button type="button" class="btn btn-warning" onclick="clearLogs('error')">Clear Error Logs</button>
                    <button type="button" class="btn btn-danger" onclick="clearLogs('all')">Clear All Logs</button>
                    <a href="/admin/logs/download?type=app" class="btn btn-info" download>Download App Logs</a>
                    <a href="/admin/logs/download?type=error" class="btn btn-info" download>Download Error Logs</a>
                    <label class="auto-refresh-toggle">
                        <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
                    </label>
                </div>
            </div>

            <div class="logs-tabs">
                <button class="tab-button active" data-tab="app" onclick="switchTab('app', this)">Application Logs</button>
                <button class="tab-button" data-tab="error" onclick="switchTab('error', this)">Error Logs</button>
            </div>

            <div id="appLogsTab" class="logs-content active">
                <div class="logs-container">
                    <pre id="appLogs" class="logs-text">Loading logs...</pre>
                </div>
            </div>

            <div id="errorLogsTab" class="logs-content">
                <div class="logs-container">
                    <pre id="errorLogs" class="logs-text">Loading logs...</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.logs-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.logs-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
    flex-wrap: wrap;
    gap: 1rem;
}

.logs-info {
    font-size: 0.9rem;
    color: #666;
}

.logs-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.auto-refresh-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #555;
    cursor: pointer;
}

.auto-refresh-toggle input[type="checkbox"] {
    cursor: pointer;
}

.logs-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.tab-button {
    padding: 0.75rem 1.5rem;
    background: #f5f5f5;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 1rem;
    color: #666;
    transition: all 0.3s;
}

.tab-button:hover {
    background: #e9e9e9;
    color: #333;
}

.tab-button.active {
    background: white;
    color: #3498db;
    border-bottom-color: #3498db;
    font-weight: bold;
}

.logs-content {
    display: none;
}

.logs-content.active {
    display: block;
}

.logs-container {
    background: #1e1e1e;
    border-radius: 5px;
    padding: 1rem;
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #333;
}

.logs-text {
    color: #d4d4d4;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.logs-text::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.logs-text::-webkit-scrollbar-track {
    background: #2d2d2d;
}

.logs-text::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.logs-text::-webkit-scrollbar-thumb:hover {
    background: #777;
}

.btn-warning {
    background-color: #f39c12;
    color: white;
}

.btn-warning:hover {
    background-color: #e67e22;
}

.btn-danger {
    background-color: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background-color: #c0392b;
}

.btn-info {
    background-color: #3498db;
    color: white;
    text-decoration: none;
    display: inline-block;
}

.btn-info:hover {
    background-color: #2980b9;
}

.alert {
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}

.alert-error {
    background: #fee;
    color: #c33;
    border: 1px solid #fcc;
}
</style>

<script>
let autoRefreshInterval = null;
let currentTab = 'app';

function switchTab(tab, buttonElement) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    if (buttonElement) {
        buttonElement.classList.add('active');
    } else {
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    }
    
    // Update tab content
    document.querySelectorAll('.logs-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tab + 'LogsTab').classList.add('active');
    
    // Refresh logs for the active tab
    refreshLogs();
}

function refreshLogs() {
    fetch('/admin/logs/data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('appLogs').textContent = data.logs || 'No logs available.';
                document.getElementById('errorLogs').textContent = data.errorLogs || 'No error logs available.';
                document.getElementById('logSize').textContent = 'App Logs: ' + data.logSizeFormatted;
                document.getElementById('errorLogSize').textContent = 'Error Logs: ' + data.errorLogSizeFormatted;
                
                // Auto-scroll to bottom
                const activeTab = document.querySelector('.logs-content.active');
                const logsContainer = activeTab.querySelector('.logs-container');
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } else {
                console.error('Failed to fetch logs:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            document.getElementById('appLogs').textContent = 'Error loading logs: ' + error.message;
            document.getElementById('errorLogs').textContent = 'Error loading logs: ' + error.message;
        });
}

function clearLogs(type) {
    const confirmMessage = type === 'all' 
        ? 'Are you sure you want to clear ALL logs? This action cannot be undone.'
        : type === 'app'
        ? 'Are you sure you want to clear application logs?'
        : 'Are you sure you want to clear error logs?';
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    fetch('/admin/logs/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            refreshLogs();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error clearing logs: ' + error.message);
    });
}

// Auto-refresh functionality
document.getElementById('autoRefresh').addEventListener('change', function(e) {
    if (e.target.checked) {
        autoRefreshInterval = setInterval(refreshLogs, 5000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
});

// Initial load
refreshLogs();

// Start auto-refresh if enabled
if (document.getElementById('autoRefresh').checked) {
    autoRefreshInterval = setInterval(refreshLogs, 5000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>

<%- include('../partials/admin_footer') %>

